name: Demo Environment

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  demo:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v6

    - name: Start demo environment
      run: |
        cd demo
        docker compose up -d --wait --wait-timeout 120
        echo "Demo environment started successfully"

    - name: Run demo and display logs (5 minutes)
      run: |
        cd demo
        
        # Set up cleanup trap
        cleanup() {
          echo "Stopping log streaming..."
          kill "$LOGS_PID" 2>/dev/null || true
        }
        trap cleanup EXIT
        
        # Run docker compose logs in background to follow all services
        docker compose logs -f mqtt-subscriber mqtt-subscriber2 mqtt-subscriber3 kafka-subscriber mqtt-publisher mqtt-publisher2 mqtt-publisher3 kafka-publisher &
        LOGS_PID=$!
        
        # Wait for 5 minutes
        sleep 300

    - name: Stop demo environment
      if: always()
      run: |
        cd demo
        docker compose down -v
