# Docker Compose file for Azure Event Hubs Emulator integration testing
# This provides the Azure Event Hubs Emulator for testing Kafka protocol compatibility

services:
  # Azurite is a dependency for the Event Hubs Emulator
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    ports:
      - "10000:10000"
      - "10001:10001"
      - "10002:10002"
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "10000"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Azure Event Hubs Emulator with Kafka support
  eventhubs-emulator:
    image: mcr.microsoft.com/azure-messaging/eventhubs-emulator:latest
    depends_on:
      azurite:
        condition: service_healthy
    ports:
      - "5672:5672"   # AMQP
      - "9092:9092"   # Kafka
    environment:
      BLOB_SERVER: azurite
      METADATA_SERVER: azurite
      ACCEPT_EULA: Y
    volumes:
      - ./test/eventhubs-emulator-config.json:/Eventhubs_Emulator/ConfigFiles/Config.json:ro
    healthcheck:
      test: ["CMD", "/bin/bash", "-c", "timeout 1 bash -c 'cat < /dev/null > /dev/tcp/127.0.0.1/9092' 2>/dev/null"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 30s

  # MQTT broker for bridge testing
  mosquitto:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
    volumes:
      - ./test/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1883", "-t", "$$SYS/#", "-E", "-i", "healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 5
