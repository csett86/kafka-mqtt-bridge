# Docker Compose file for Kafka-MQTT Bridge Demo
# 
# This demo now uses Redpanda and Redpanda Connect MQTT connectors to move data between MQTT brokers and Kafka topics:
# - MQTT topic "transactions" → Redpanda topic "transactions"
# - Redpanda topic "master_data" → MQTT topic "master_data"
#
# Components:
# - mosquitto, mosquitto2, mosquitto3: Three MQTT brokers
# - redpanda: Kafka-compatible broker
# - connect: Redpanda Connect worker hosting MQTT connectors
# - configure-connect: One-shot job to apply MQTT source/sink connector configs
# - mqtt-publisher, mqtt-publisher2, mqtt-publisher3: Publish to "transactions" on each mosquitto
# - kafka-subscriber: Listens to "transactions" topic
# - kafka-publisher: Publishes to "master_data" topic every 10 seconds
# - mqtt-subscriber, mqtt-subscriber2, mqtt-subscriber3: Listen to "master_data" on each mosquitto
#
# Usage:
#   docker compose up
#
# To see the demo in action, observe the logs:
#   - mqtt-publisher* send to MQTT "transactions" on their respective mosquitto brokers
#   - MQTT source connectors push to Redpanda "transactions"
#   - kafka-subscriber receives from Redpanda "transactions"
#   - kafka-publisher sends to Redpanda "master_data"
#   - MQTT sink connectors push "master_data" to each mosquitto
#   - mqtt-subscriber* receive from MQTT "master_data" on their respective mosquitto brokers

services:
  # MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1883", "-t", "$$SYS/#", "-E", "-i", "healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 5

  # MQTT Broker 2
  mosquitto2:
    image: eclipse-mosquitto:2.0
    ports:
      - "1884:1884"
    volumes:
      - ./mosquitto2.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1884", "-t", "$$SYS/#", "-E", "-i", "healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 5

  # MQTT Broker 3
  mosquitto3:
    image: eclipse-mosquitto:2.0
    ports:
      - "1885:1885"
    volumes:
      - ./mosquitto3.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1885", "-t", "$$SYS/#", "-E", "-i", "healthcheck"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Redpanda Broker
  redpanda:
    image: redpandadata/redpanda:v24.3.5
    command:
      - redpanda
      - start
      - --smp
      - "1"
      - --memory
      - 1G
      - --overprovisioned
      - --node-id
      - "0"
      - --check=false
    ports:
      - "9092:9092"
      - "9644:9644"
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster metadata --brokers localhost:9092 >/dev/null 2>&1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 10s

  # Redpanda Connect worker hosting MQTT connectors
  connect:
    image: docker.redpanda.com/redpandadata/connectors:latest
    depends_on:
      redpanda:
        condition: service_healthy
    environment:
      CONNECT_BOOTSTRAP_SERVERS: "redpanda:9092"
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: "connect-cluster"
      CONNECT_CONFIG_STORAGE_TOPIC: "_redpanda_connect_configs"
      CONNECT_OFFSET_STORAGE_TOPIC: "_redpanda_connect_offsets"
      CONNECT_STATUS_STORAGE_TOPIC: "_redpanda_connect_status"
      CONNECT_CONFIG_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_OFFSET_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_STATUS_STORAGE_REPLICATION_FACTOR: 1
      CONNECT_KEY_CONVERTER: "org.apache.kafka.connect.storage.StringConverter"
      CONNECT_VALUE_CONVERTER: "org.apache.kafka.connect.json.JsonConverter"
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_PLUGIN_PATH: "/opt/kafka/connectors"
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD-SHELL", "curl -fs http://localhost:8083/connectors || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 20s

  # Apply MQTT source/sink connector configurations
  configure-connect:
    image: curlimages/curl:8.11.1
    depends_on:
      connect:
        condition: service_healthy
    volumes:
      - ./connectors:/connectors:ro
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Waiting for Redpanda Connect..."
        until curl -fs http://connect:8083/connectors; do
          sleep 2
        done
        for cfg in /connectors/*.json; do
          name=$$(basename $$cfg .json)
          echo "Applying connector $$name..."
          curl -fs -X PUT -H "Content-Type: application/json" --data @$$cfg http://connect:8083/connectors/$$name/config || exit 1
        done
        echo "Connectors applied"
    restart: "no"

  # MQTT Publisher - publishes to "transactions" topic every second
  mqtt-publisher:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT publisher on topic 'transactions'..."
        i=1
        while true; do
          timestamp=$$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          message="{\"id\": \"s1-$$i\", \"type\": \"transaction\", \"amount\": $$((RANDOM % 1000)), \"timestamp\": \"$$timestamp\"}"
          mosquitto_pub -h mosquitto -p 1883 -t transactions -m "$$message"
          echo "[MQTT->Kafka] Published to mosquitto 'transactions': $$message"
          i=$$((i + 1))
          sleep 1
        done

  # MQTT Publisher 2 - publishes to "transactions" topic on mosquitto2 every second
  mqtt-publisher2:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto2:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT publisher 2 on topic 'transactions'..."
        i=1
        while true; do
          timestamp=$$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          message="{\"id\": \"s2-$$i\", \"type\": \"transaction\", \"amount\": $$((RANDOM % 1000)), \"timestamp\": \"$$timestamp\"}"
          mosquitto_pub -h mosquitto2 -p 1884 -t transactions -m "$$message"
          echo "[MQTT->Kafka] Published to mosquitto2 'transactions': $$message"
          i=$$((i + 1))
          sleep 1
        done

  # MQTT Publisher 3 - publishes to "transactions" topic on mosquitto3 every second
  mqtt-publisher3:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto3:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT publisher 3 on topic 'transactions'..."
        i=1
        while true; do
          timestamp=$$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          message="{\"id\": \"s3-$$i\", \"type\": \"transaction\", \"amount\": $$((RANDOM % 1000)), \"timestamp\": \"$$timestamp\"}"
          mosquitto_pub -h mosquitto3 -p 1885 -t transactions -m "$$message"
          echo "[MQTT->Kafka] Published to mosquitto3 'transactions': $$message"
          i=$$((i + 1))
          sleep 1
        done

  # Kafka Subscriber - listens to "transactions" topic
  kafka-subscriber:
    image: apache/kafka:4.1.1
    depends_on:
      redpanda:
        condition: service_healthy
      configure-connect:
        condition: service_completed_successfully
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting Kafka subscriber on topic 'transactions'..."
        /opt/kafka/bin/kafka-console-consumer.sh --bootstrap-server redpanda:9092 --topic transactions --from-beginning | while read line; do
          echo "[MQTT->Kafka] Received from Redpanda 'transactions': $$line"
        done

  # Kafka Publisher - publishes to "master_data" topic every 10 seconds
  kafka-publisher:
    image: apache/kafka:4.1.1
    depends_on:
      redpanda:
        condition: service_healthy
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting Kafka publisher on topic 'master_data'..."
        i=1
        sleep 10
        while true; do
          timestamp=$$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          message="{\"id\": $$i, \"type\": \"master_data\", \"name\": \"Product-$$i\", \"timestamp\": \"$$timestamp\"}"
          echo "$$message" | /opt/kafka/bin/kafka-console-producer.sh --bootstrap-server redpanda:9092 --topic master_data
          echo "[Kafka->MQTT] Published to 'master_data': $$message"
          i=$$((i + 1))
          sleep 10
        done

  # MQTT Subscriber - listens to "master_data" topic
  mqtt-subscriber:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto:
        condition: service_healthy
      configure-connect:
        condition: service_completed_successfully
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT subscriber on topic 'master_data'..."
        sleep 5
        mosquitto_sub -h mosquitto -p 1883 -t master_data -v | while read line; do
          echo "[Kafka->MQTT] Received from mosquitto: $$line"
        done

  # MQTT Subscriber 2 - listens to "master_data" topic on mosquitto2
  mqtt-subscriber2:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto2:
        condition: service_healthy
      configure-connect:
        condition: service_completed_successfully
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT subscriber 2 on topic 'master_data'..."
        sleep 5
        mosquitto_sub -h mosquitto2 -p 1884 -t master_data -v | while read line; do
          echo "[Kafka->MQTT] Received from mosquitto2: $$line"
        done

  # MQTT Subscriber 3 - listens to "master_data" topic on mosquitto3
  mqtt-subscriber3:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto3:
        condition: service_healthy
      configure-connect:
        condition: service_completed_successfully
    entrypoint: /bin/sh
    command:
      - -c
      - |
        echo "Starting MQTT subscriber 3 on topic 'master_data'..."
        sleep 5
        mosquitto_sub -h mosquitto3 -p 1885 -t master_data -v | while read line; do
          echo "[Kafka->MQTT] Received from mosquitto3: $$line"
        done
